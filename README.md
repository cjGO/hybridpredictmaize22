hybridpredictmaize22
================

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

Repo for analysis of GEM prediction for maize yield

## Install

``` sh
pip install hybridpredictmaize22
```

## How to use

A demo of the library specifically for this dataset

Generate random data that is the same form as the actual dataset

``` python
import random
#generate random SNP matrix
gene_dosages = [0, .5, 1]
years = [2018,2019]
snp_length = 100
number_hybrids = 20


number_environments = 10
env_col = []
for i,y in zip(np.arange(number_environments),[random.choice(years) for _ in range(number_environments)]):
    env_col.append(f'{i}_{y}')

snp_matrix = (np.arange(number_hybrids),np.array([[random.choice(gene_dosages) for x in range(snp_length)] for _ in range(number_hybrids)]))

#generate random yield data
random_yields = [random.uniform(-1,1) for _ in range(100)]
random_hybrids = [random.choice(range(number_hybrids)) for _ in range(100)]
random_environments = [random.choice((env_col)) for _ in range(100)]
```

``` python
yield_data = pd.DataFrame({"Hybrid":random_hybrids, "Yield_Mg_ha":random_yields, 'Env':random_environments})
yield_data.head()
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Hybrid</th>
      <th>Yield_Mg_ha</th>
      <th>Env</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>14</td>
      <td>0.219848</td>
      <td>5_2019</td>
    </tr>
    <tr>
      <th>1</th>
      <td>16</td>
      <td>0.538425</td>
      <td>8_2019</td>
    </tr>
    <tr>
      <th>2</th>
      <td>16</td>
      <td>0.921895</td>
      <td>2_2019</td>
    </tr>
    <tr>
      <th>3</th>
      <td>6</td>
      <td>-0.993358</td>
      <td>4_2019</td>
    </tr>
    <tr>
      <th>4</th>
      <td>6</td>
      <td>-0.722921</td>
      <td>2_2019</td>
    </tr>
  </tbody>
</table>
</div>

``` python
Weather_Table = np.random.random((50,number_environments))
weather_table = {}
for c,i in enumerate(Weather_Table):
    weather_table[c] = i
    
weather_data = pd.DataFrame(weather_table)
weather_data.insert(0,'Env',env_col)
weather_data.insert(1,'Year',[x.split('_')[1] for x in env_col])

(weather_data)
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Env</th>
      <th>Year</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>...</th>
      <th>40</th>
      <th>41</th>
      <th>42</th>
      <th>43</th>
      <th>44</th>
      <th>45</th>
      <th>46</th>
      <th>47</th>
      <th>48</th>
      <th>49</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0_2018</td>
      <td>2018</td>
      <td>0.090504</td>
      <td>0.190406</td>
      <td>0.487055</td>
      <td>0.856964</td>
      <td>0.048595</td>
      <td>0.782404</td>
      <td>0.932119</td>
      <td>0.604640</td>
      <td>...</td>
      <td>0.327276</td>
      <td>0.811860</td>
      <td>0.250868</td>
      <td>0.967916</td>
      <td>0.717378</td>
      <td>0.041461</td>
      <td>0.853717</td>
      <td>0.570870</td>
      <td>0.865140</td>
      <td>0.974558</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1_2018</td>
      <td>2018</td>
      <td>0.832647</td>
      <td>0.438793</td>
      <td>0.434207</td>
      <td>0.318412</td>
      <td>0.056956</td>
      <td>0.369894</td>
      <td>0.356342</td>
      <td>0.922811</td>
      <td>...</td>
      <td>0.734138</td>
      <td>0.751515</td>
      <td>0.169039</td>
      <td>0.395011</td>
      <td>0.146937</td>
      <td>0.102186</td>
      <td>0.499660</td>
      <td>0.098832</td>
      <td>0.473252</td>
      <td>0.071471</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2_2019</td>
      <td>2019</td>
      <td>0.755381</td>
      <td>0.202103</td>
      <td>0.209770</td>
      <td>0.841516</td>
      <td>0.154603</td>
      <td>0.789997</td>
      <td>0.106939</td>
      <td>0.026476</td>
      <td>...</td>
      <td>0.288460</td>
      <td>0.923316</td>
      <td>0.272401</td>
      <td>0.359577</td>
      <td>0.656206</td>
      <td>0.450100</td>
      <td>0.495506</td>
      <td>0.509083</td>
      <td>0.514762</td>
      <td>0.172253</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3_2018</td>
      <td>2018</td>
      <td>0.469916</td>
      <td>0.646785</td>
      <td>0.881478</td>
      <td>0.499406</td>
      <td>0.653779</td>
      <td>0.493970</td>
      <td>0.785830</td>
      <td>0.241786</td>
      <td>...</td>
      <td>0.784110</td>
      <td>0.217957</td>
      <td>0.069367</td>
      <td>0.995609</td>
      <td>0.600673</td>
      <td>0.493468</td>
      <td>0.010605</td>
      <td>0.979546</td>
      <td>0.746203</td>
      <td>0.454766</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4_2019</td>
      <td>2019</td>
      <td>0.685245</td>
      <td>0.603269</td>
      <td>0.552968</td>
      <td>0.857774</td>
      <td>0.590732</td>
      <td>0.553667</td>
      <td>0.072938</td>
      <td>0.799972</td>
      <td>...</td>
      <td>0.671518</td>
      <td>0.048937</td>
      <td>0.626047</td>
      <td>0.607124</td>
      <td>0.585469</td>
      <td>0.794031</td>
      <td>0.993070</td>
      <td>0.067475</td>
      <td>0.373957</td>
      <td>0.408206</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5_2019</td>
      <td>2019</td>
      <td>0.428437</td>
      <td>0.814462</td>
      <td>0.940537</td>
      <td>0.077722</td>
      <td>0.661550</td>
      <td>0.317286</td>
      <td>0.346178</td>
      <td>0.678108</td>
      <td>...</td>
      <td>0.258266</td>
      <td>0.964766</td>
      <td>0.418675</td>
      <td>0.586637</td>
      <td>0.316594</td>
      <td>0.534758</td>
      <td>0.271571</td>
      <td>0.379752</td>
      <td>0.765951</td>
      <td>0.113872</td>
    </tr>
    <tr>
      <th>6</th>
      <td>6_2019</td>
      <td>2019</td>
      <td>0.264825</td>
      <td>0.961481</td>
      <td>0.166661</td>
      <td>0.764215</td>
      <td>0.149717</td>
      <td>0.434268</td>
      <td>0.632117</td>
      <td>0.851591</td>
      <td>...</td>
      <td>0.514611</td>
      <td>0.488366</td>
      <td>0.019868</td>
      <td>0.487827</td>
      <td>0.040701</td>
      <td>0.615436</td>
      <td>0.442033</td>
      <td>0.844340</td>
      <td>0.171262</td>
      <td>0.637241</td>
    </tr>
    <tr>
      <th>7</th>
      <td>7_2018</td>
      <td>2018</td>
      <td>0.478966</td>
      <td>0.355626</td>
      <td>0.429861</td>
      <td>0.398623</td>
      <td>0.320606</td>
      <td>0.090721</td>
      <td>0.254338</td>
      <td>0.050240</td>
      <td>...</td>
      <td>0.216189</td>
      <td>0.289679</td>
      <td>0.782013</td>
      <td>0.197285</td>
      <td>0.778175</td>
      <td>0.133279</td>
      <td>0.247789</td>
      <td>0.138276</td>
      <td>0.451989</td>
      <td>0.483286</td>
    </tr>
    <tr>
      <th>8</th>
      <td>8_2019</td>
      <td>2019</td>
      <td>0.799479</td>
      <td>0.299206</td>
      <td>0.077325</td>
      <td>0.354348</td>
      <td>0.537312</td>
      <td>0.794558</td>
      <td>0.910754</td>
      <td>0.728746</td>
      <td>...</td>
      <td>0.121775</td>
      <td>0.117276</td>
      <td>0.719571</td>
      <td>0.691089</td>
      <td>0.481006</td>
      <td>0.108865</td>
      <td>0.716467</td>
      <td>0.358639</td>
      <td>0.693075</td>
      <td>0.356856</td>
    </tr>
    <tr>
      <th>9</th>
      <td>9_2019</td>
      <td>2019</td>
      <td>0.101469</td>
      <td>0.576532</td>
      <td>0.148550</td>
      <td>0.670102</td>
      <td>0.878643</td>
      <td>0.931698</td>
      <td>0.369360</td>
      <td>0.253712</td>
      <td>...</td>
      <td>0.131750</td>
      <td>0.783244</td>
      <td>0.476852</td>
      <td>0.234867</td>
      <td>0.101564</td>
      <td>0.791949</td>
      <td>0.645135</td>
      <td>0.263196</td>
      <td>0.353880</td>
      <td>0.956912</td>
    </tr>
  </tbody>
</table>
<p>10 rows × 52 columns</p>
</div>

``` python
yield_data
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Hybrid</th>
      <th>Yield_Mg_ha</th>
      <th>Env</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>14</td>
      <td>0.219848</td>
      <td>5_2019</td>
    </tr>
    <tr>
      <th>1</th>
      <td>16</td>
      <td>0.538425</td>
      <td>8_2019</td>
    </tr>
    <tr>
      <th>2</th>
      <td>16</td>
      <td>0.921895</td>
      <td>2_2019</td>
    </tr>
    <tr>
      <th>3</th>
      <td>6</td>
      <td>-0.993358</td>
      <td>4_2019</td>
    </tr>
    <tr>
      <th>4</th>
      <td>6</td>
      <td>-0.722921</td>
      <td>2_2019</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>95</th>
      <td>7</td>
      <td>-0.258061</td>
      <td>1_2018</td>
    </tr>
    <tr>
      <th>96</th>
      <td>8</td>
      <td>-0.081160</td>
      <td>5_2019</td>
    </tr>
    <tr>
      <th>97</th>
      <td>16</td>
      <td>0.219072</td>
      <td>2_2019</td>
    </tr>
    <tr>
      <th>98</th>
      <td>11</td>
      <td>0.660305</td>
      <td>0_2018</td>
    </tr>
    <tr>
      <th>99</th>
      <td>3</td>
      <td>-0.383118</td>
      <td>1_2018</td>
    </tr>
  </tbody>
</table>
<p>100 rows × 3 columns</p>
</div>

``` python
#Create a GEM dataset
test_split = 2019
gem = GEM(test_split)
gem.Y = YT(yield_data, test_split)
gem.W = WT(weather_data, test_split)
gem.SNP = snp_matrix
```

``` python
#example of how to unscale a value
gem.Y.scaler.inverse_transform(np.array(1.4).reshape(-1,1))
```

    array([[0.90851887]])

``` python
gem.Y.plot_yields()
```

![](index_files/figure-commonmark/cell-9-output-1.png)

``` python
ds = GemDataset(gem.W.Tr, gem.Y.Tr, gem.SNP)
next(iter(ds))
```

    (tensor(1.0784),
     tensor([0.5000, 1.0000, 0.0000, 0.5000, 1.0000, 0.5000, 1.0000, 1.0000, 0.5000,
             1.0000, 1.0000, 1.0000, 0.5000, 0.5000, 0.5000, 0.0000, 0.0000, 1.0000,
             1.0000, 0.0000]),
     tensor([[-1.4382, -1.3233, -0.3781,  1.6458, -0.8959,  1.4013,  1.2327,  0.4463,
              -0.7229, -0.2873, -0.5451, -0.1503,  1.4959,  1.1136,  1.3282,  0.1368,
               1.0135,  0.3244,  0.6011,  0.2159, -0.8605, -1.3633, -0.5668,  1.3842,
               1.1609,  1.2320,  1.4353, -0.6019, -0.3024,  0.1582, -1.6429, -0.0138,
              -0.2204, -0.4309, -1.6313,  1.0133, -0.7903, -0.6035, -0.5002,  1.3964,
              -0.7603,  1.1056, -0.2429,  0.9399,  0.6332, -0.8548,  1.4426,  0.3454,
               1.3068,  1.4927]]))

``` python
tr_ds = GemDataset(gem.W.Tr, gem.Y.Tr, gem.SNP)
te_ds = GemDataset(gem.W.Te, gem.Y.Te, gem.SNP)
```

``` python
tr_dl = DataLoader(tr_ds, batch_size=4)
te_dl = DataLoader(te_ds, batch_size=4)
dls = DataLoaders(tr_dl,te_dl)
```

``` python
class MLP(torch.nn.Module):
    def __init__(self, input_size, hidden_size, output_size):
        super(MLP, self).__init__()
        self.fc1 = nn.Linear(input_size, hidden_size)
        self.fc2 = nn.Linear(hidden_size, output_size)

    def forward(self, x):
        x = self.fc1(x)
        x = torch.relu(x)
        x = self.fc2(x)
        return x
```

``` python
from torcheval.metrics import MeanSquaredError,Mean, R2Score
```

``` python
model = MLP(20,100, 1)
cbs = [TrainCB()]
learn = Learner(model, dls, F.mse_loss, lr=.25, cbs=cbs)
learn.fit(1)
```
